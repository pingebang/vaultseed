# VaultSeed 安全评估报告

## 评估日期
2025年12月2日

## 系统概述
VaultSeed 是一个端到端加密的内容存储系统，使用以太坊钱包进行身份验证，采用混合加密方案（RSA-OAEP + AES-GCM）保护用户数据。

## 安全架构分析

### 1. 加密方案
**实现：** RSA-OAEP (2048位) + AES-GCM (256位) 混合加密
**评估：**
- ✅ 使用标准加密算法（RSA-OAEP, AES-GCM）
- ✅ 密钥长度符合当前安全标准（RSA 2048, AES 256）
- ✅ 使用随机IV和nonce防止重放攻击
- ✅ 前端使用Web Crypto API，避免第三方库依赖
- ⚠️ RSA 2048位正在逐渐被淘汰，建议考虑RSA 3072或ECC

### 2. 密钥管理
**实现：**
- 密钥在客户端生成和存储
- 私钥不发送到服务器
- 使用PBKDF2进行密钥备份加密

**评估：**
- ✅ 真正的端到端加密（服务器无法解密用户数据）
- ✅ 私钥保持在客户端，符合零知识原则
- ⚠️ 当前使用localStorage存储密钥，页面刷新后私钥丢失
- ⚠️ 密钥备份使用PBKDF2，但迭代次数固定为100,000
- ❗ **严重问题：** `getStoredKeyPair()`函数返回的私钥为`null`，实际无法从存储恢复私钥

### 3. 身份验证
**实现：** 以太坊签名验证
**评估：**
- ✅ 使用标准的EIP-191签名消息格式
- ✅ 验证签名和地址匹配
- ✅ 使用nonce防止重放攻击
- ✅ 每次解密都需要新的签名
- ⚠️ 依赖MetaMask或类似钱包，可能存在钱包安全问题

### 4. 数据传输安全
**实现：** HTTPS + 数据已加密
**评估：**
- ✅ 生产环境配置了HTTPS（通过Traefik + Let's Encrypt）
- ✅ 敏感数据在传输前已加密
- ✅ API使用JWT-like token进行认证
- ⚠️ 开发环境可能使用HTTP，需要注意

### 5. 数据库安全
**实现：** SQLite数据库
**评估：**
- ✅ 存储的是加密数据，即使数据库泄露也无法解密
- ✅ 用户公钥和加密内容分开存储
- ⚠️ SQLite文件可能被直接访问，需要文件系统权限控制
- ⚠️ 缺乏数据库加密（SQLite加密扩展）

### 6. 部署安全
**实现：** Docker容器化 + Traefik反向代理
**评估：**
- ✅ 使用非root用户运行容器
- ✅ 配置了安全HTTP头（CSP, HSTS等）
- ✅ 使用Let's Encrypt自动证书管理
- ⚠️ Traefik Dashboard在生产环境中启用且不安全
- ⚠️ 缺乏容器漏洞扫描和更新策略

## 潜在泄露风险

### 高风险问题
1. **私钥存储问题** - `secureCrypto.ts`中的`getStoredKeyPair()`函数无法恢复私钥，导致用户每次刷新页面都会丢失解密能力。
2. **Traefik Dashboard暴露** - 生产环境中Traefik Dashboard启用且未设置认证。

### 中风险问题
1. **localStorage使用** - 敏感信息存储在localStorage中，容易受到XSS攻击。
2. **RSA密钥强度** - 2048位RSA正在被逐步淘汰，建议升级到3072位或使用ECC。
3. **PBKDF2迭代次数** - 固定为100,000次，建议根据设备性能动态调整或增加。

### 低风险问题
1. **SQLite数据库加密** - 缺乏透明数据加密。
2. **错误信息泄露** - 某些错误信息可能泄露系统信息。

## 改进建议

### 立即修复（高优先级）
1. **修复私钥存储**：
   - 实现真正的私钥持久化存储（IndexedDB + 密码保护）
   - 或使用WebAuthn/Passkeys进行密钥管理

2. **保护Traefik Dashboard**：
   ```yaml
   # 在docker-compose.prod.yml中
   - "--api.dashboard=false"  # 或设置基本认证
   ```

3. **增强localStorage安全**：
   - 实现Content Security Policy (CSP)
   - 考虑使用HttpOnly cookies存储认证token

### 中期改进
1. **升级加密算法**：
   - 迁移到RSA 3072或ECC (P-256)
   - 考虑使用libsodium或Web Crypto API的ECDH

2. **改进密钥备份**：
   - 增加PBKDF2迭代次数（至少600,000）
   - 添加Argon2id支持

3. **数据库安全**：
   - 启用SQLite加密扩展
   - 定期备份和加密备份文件

### 长期增强
1. **多因素认证** - 添加第二因素认证
2. **审计日志** - 实现完整的操作审计
3. **密钥轮换** - 支持定期密钥轮换
4. **防暴力破解** - 实现API速率限制和账户锁定

## 结论

VaultSeed实现了基本的端到端加密架构，核心安全原则（服务器无法解密用户数据）得到遵守。然而，存在几个关键的安全问题需要立即解决，特别是私钥存储和Traefik Dashboard暴露问题。

**总体安全评级：中等** - 在修复高优先级问题后，可提升到良好。

## 验证测试建议

1. 运行OWASP ZAP或类似工具进行漏洞扫描
2. 进行渗透测试，特别是针对API端点
3. 审计所有错误处理路径，确保不泄露敏感信息
4. 测试不同浏览器的Web Crypto API兼容性
5. 验证备份和恢复流程的安全性
